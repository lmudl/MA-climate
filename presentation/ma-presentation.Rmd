---
title: "Predicting Droughts in the Amazon Basin based on Global Sea Surface Temperatures"
author: Dario Lepke
date: September 09, 2022
output: 
  bookdown::pdf_book:
    toc: true
    base_format: "function(..., number_sections) rmarkdown::beamer_presentation(...)"
    number_sections: true
    theme: "metropolis"
    includes:
      in_header: head.tex
    slide_level: 2
  ioslides_presentation:
    logo: "../thesis/sigillum.png"
  beamer_presentation:
    theme: "metropolis"
    slide_level: 3
    toc: true
    includes:
      in_header: head.tex
bibliography: "../thesis/0-ref-lib.bib"
---

```{r, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
# 25-30 minuten, also wsl maximal 40 slides

# always explain motivation for each step
# explain methods 
# explain results

# Notes in general 
# Greetings, main title slide
# Slides with table of contents
# Motivation
## Amazonas huge ecosystem important carbon sink
## droughts in the amazonas affect millions of livelihoods
## predicting droughts and precipitation is important problem
## incoming: ciemer et al.

# Related work
## Ciemter et al created early warning systems based on SST alone
## show and explain cross degress
## first only cross degrees with
## show and explain early warning signal 

# Explorative Analysis
## Precipitation how much?
## glyphs definitely
## SST maybe

# Correlation analysis
## different timelags
## show differences of raw and deseasonalized data

# Clustering analysis
## compare k-means ad k-medoids
## show clusters on map
## show results for the 5 clusters
## show only predicted values of the final clusters

```


# Introduction

## Motivation

- The Amazon basin is a key hotspot of biodiversity, carbon storage and moisture recycling

- Hydrological extremes affect ecosystem and populations tremendously

- Droughts in the Amazon rainforest can have severe biomass carbon impact 

- Severe Amazon drought in 2010 had total biomass carbon impact of 2.2 PgC, affected area $3 mio km^2$


## Related work

- @ciemer2020early established an early warning indicator
for water deficits in the central Amazon basin (CAB)

```{r cross, echo = FALSE, fig.align = 'center', out.width = '50%', fig.cap='Cross degree between sea surface temperature and continental rainfall anomalies. For each grid cell of sea surface temperature in the Atlantic and Pacific, the cross degree towards rainfall in the Central Amazon Basin (blue box) is shown, for a positive correlations and b negative correlations. Darker shading indicates a larger cross degree, implying a larger number of links and thus significant correlations with rainfall at more grid points in the Central Amazon Basin. Red areas outline coherent oceanic regions with a the 20\\% highest cross degrees for positive correlations, found in the Southern Pacific Ocean (SPO) and Southern Tropical Atlantic Ocean (STAO), and b the 20\\% highest cross degrees for negative correlations, found in the Central Pacific Ocean (CPO) and Northern Tropical Atlantic Ocean (NTAO) (Ciemer et al. (2020))'}
knitr::include_graphics("../figures/cross-degree.jpg")
```

- They investigate the correlation over time of NTAO and STAO
and its relationship to droughts in the  CAB

```{r early, echo = FALSE, fig.align='center' ,out.width='75%', fig.cap='Early-warning signal for droughts in the central Amazon basin. We compare the time evolution of the average cross-correlation of the Northern Tropical Atlantic Ocean (NTAO) and Southern Tropical Atlantic Ocean (STAO), given by the blue curve, with the standardized precipitation index (SPI, orange) of the central Amazon basin. Orange dips indicate a negative SPI with a threshold for severely dry periods (SPI -1, dotted red line). We expect a drought event within the following one and a half years whenever the average cross-correlation between NTAO and STAO SST anomalies falls below an empirically found threshold of -0.06. Green circles indicate a matching forecast based on the Atlantic SST correlation structure, with one false alarm in 2002 indicated by a grey circle, where the threshold is crossed, but no drought took place in the direct aftermath (see Discussion). The temporal evolution of the average cross-correlation shown here is smoothed using a Chebyshev type-I low-pass filter with a cutoff at 24 months (Ciemer et al. (2020)).'}
knitr::include_graphics("../figures/early-warning-signals.jpg")
```

## Our approach

- Inspect spatial and temporal characteristics in raw data
- Directly predict rain from SST
- Use lasso and fused lasso
- model evaluation with cross validation for time series


# Explorative analysis

## The data
- Rain data from CHIRPS ()
- CHIRPS contains in-situ and satellite data
- SST data from ERSST (Extended Reconstructed Sea Surface Temperature)
- ERSST is reanalysis of observation data (made by ships and buoys for example), missing data filled by interpolation techniques
- These are the same data sets as in @ciemer2020early

## Explorative analysis Rain

- show area
- show mean and sd
- show glyph plots

## Explorative analysis SST

- show mean and sd

# Correlation analysis

- show timelag 0, raw and de-seasonalized

# Clustering
## Motivation/ Overview 
- explorative analysis has shown spatial and temporal differences in the precipitation data
- we explored this further using k-means clustering
- steps: find optimal k via pca and gap statistic
- apply k-means to original precipitation data

- we compared k-means and k-medoid with and without PCA via the gap statistic
- here show only k-means with PCA as it gave best results 
- applying the regression models to separate clusters might improve predictions


- Using 3 principal components and 5 cluster centers with k-means
gave best results on gap statistic
- we want to explore this further using a PCA and k-means clustering
- find optimal number of k with the gap statistic
- applying the regression models to separate clusters might improve predictions

## $k$-means
- Our objective is to find $k$ internally homogeneous and externally heterogeneous clusters
- Similarity is measured by the euclidean distance

\begin{equation} 
d(x_i,x_{i'}) = \sum_{j=1}^p(x_{ij}-x_{i'j})^2=||x_i-x_{i'}||^2
(\#eq:eucl-dist)
\end{equation}

- And we want to minimize the sum of distances inside all clusters, given by:

\begin{equation} 
W(C) = \frac{1}{2} \sum_{k=1}^{K} \sum_{C(i)=k} \sum_{C(i')=k} ||x_i-x_{i'}||^2 
= \sum_{k=1}^K N_k \sum_{C(i)=k} ||x_i-\bar{x}_k ||^2
(\#eq:wss)
\end{equation}

where $\bar{x} = (\bar{x}_{1k},...,\bar{x}_{pk})$ stands for the mean vectors of the $k$th
cluster and $N_k = \sum_{i=1}^N I(C(i)=k)$. 

## gap statistic
- number of clusters has to be defined beforehand
- we decided on the optimal number of $k$ using the gap statistic
- Let $W_k$ be $W(C)$ for fix $k$
- We compare $W_k$ from the precipitation data with average $W^*_k$ from $B$ Monte Carlo sampled data sets

\begin{equation}
Gap(k) = E\{log(W*_k) \} - log(W_k).
(\#eq:gap)
\end{equation}

- We choose $k$ as smallest k such that 

\begin{equation}
Gap(k) \geq Gap(k+1) - s_{k+1}
\end{equation}

- $s_{k+1}$ is $sd_k\sqrt{1+1/B}$, and sd the standard deviation of log(W*_k)

## PCA
- Before running k-means we apply a PCA to reduce the large number of correlated variables to a few
- The new variables are linear combinations of the original variables
- Here: Each variable is a month of precipitation data in the CAB

```{r}
library(ggplot2)
scree <-readRDS("../results/clustering/scree_plot_pca_centered.rds")
scree + ylim(c(0,0.5))
```


```{r}
library(patchwork)
p3 <- readRDS("../results/clustering/replotted_gap_pc3_centered_kmeans_plot.rds")
p4 <- readRDS("../results/clustering/replotted_gap_pc4_centered_kmeans_plot.rds")
p3 + p4
```



## Results

# The lasso

# The fused lasso

# Summary

# Important test

