# Lasso on original data

```{r, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
```


```{r}
library(patchwork)
library(ggpubr)
library(raster)
library(glmnet)
library(Hmisc)
source("../code/R/helper-functions.R")
```

```{r}
path_to_model_folder <- "../results/CV-lasso/cluster-cv-lasso-og/cluster-1/"
```


## LASSO model

We fit a LASSO model on the precipitation and SST data.
The precipitation target is the monthly mean precipitation
in the Central Amazon Basin, the SST data are monthly temperatures
over the globe.
We use a 5-fold CV approach to find an optimal lambda.
Each fold consists of 5 consecutive years of training data
followed by 2 years of test data.
In each fold we fit a LASSO model on a set of predetermined lambda 
values and choose the lambda that minimizes the MSE on the test set 
in that fold.
After determining the best lambda in each fold we choose the
lambda that minimizes the MSE over all folds and refit the model
to the complete training data. Afterwards we evaluate the fitted model on a separate validation set with 5 years length which was not included
in the training phase.

## Error plots


```{r}
err_bars_plot <- readRDS(paste0(path_to_model_folder, "/err-mat-plots/err-bars-plot.rds"))
err_bars_plot
```


```{r}
p1 <- readRDS(paste0(path_to_model_folder, "err-mat-plots/err-plot-fold-1.rds"))
p2 <- readRDS(paste0(path_to_model_folder, "err-mat-plots/err-plot-fold-2.rds"))
p3 <- readRDS(paste0(path_to_model_folder, "err-mat-plots/err-plot-fold-3.rds"))
p4 <- readRDS(paste0(path_to_model_folder, "err-mat-plots/err-plot-fold-4.rds"))
p5 <- readRDS(paste0(path_to_model_folder, "err-mat-plots/err-plot-fold-5.rds"))

p1 + p2 + p3 + p4 + p5
```



Below we can see the minimum MSE for each fold.
```{r}
#apply(err_mat, 2, min)
```
And which lambda in the lambda vector resulted in the lowest prediction error on the foldsÂ´ test set.

```{r}
#apply(err_mat, 2, function(x) which.min(x))
```



## Coefficient plots

```{r}
pc1 <- readRDS(paste0(path_to_model_folder, "coef-plots/coef-plot-fold-1.rds"))
pc2 <- readRDS(paste0(path_to_model_folder, "coef-plots/coef-plot-fold-2.rds"))
pc3 <- readRDS(paste0(path_to_model_folder, "coef-plots/coef-plot-fold-3.rds"))
pc4 <- readRDS(paste0(path_to_model_folder, "coef-plots/coef-plot-fold-4.rds"))
pc5 <- readRDS(paste0(path_to_model_folder, "coef-plots/coef-plot-fold-5.rds"))



l <- list(pc1,pc2,pc3,pc4,pc5)
ggarrange(plotlist = l, ncol = 3, nrow = 2,
         common.legend = TRUE)
```


## Inspect predictions from each fold

Following we inspect the folds precipitation time series and
the predictions made by the model.


```{r}
pred_plot_1 <- readRDS(paste0(path_to_model_folder, "/pred-plots/pred-plot-fold-1.rds"))
pred_plot_1
```
```{r}
pred_plot_2 <- readRDS(paste0(path_to_model_folder, "/pred-plots/pred-plot-fold-2.rds"))
pred_plot_2
```
```{r}
pred_plot_3 <- readRDS(paste0(path_to_model_folder, "/pred-plots/pred-plot-fold-3.rds"))
pred_plot_3
```
```{r}
pred_plot_4 <- readRDS(paste0(path_to_model_folder, "/pred-plots/pred-plot-fold-4.rds"))
pred_plot_4
```
```{r}
pred_plot_5 <- readRDS(paste0(path_to_model_folder, "/pred-plots/pred-plot-fold-5.rds"))
pred_plot_5
```

## Inspect predictions from best CV-lambda

We choose now the best lambda with the 1SE rule and fit 
the model anew to predict the time series we held out
as validation data




```{r}
full_preds <- readRDS(paste0(path_to_model_folder, "/pred-plots/pred-plot-full.rds"))
full_preds
```


## Summary
