## Analyse clustering results {#clustering-analyze-results}


```{r, echo=FALSE}
library(patchwork)
library(ggplot2)
#bookdown::preview_chapter("code/Rmarkdown/thesis/3-clustering-results.Rmd")
gettorepo <- "../"
```

We now analyze further the results we found.
Namely the clusters we find after performing a PCA on the data,
using the 3 first principal components and searching for 5 clusters using $k$-means. The first 3 principal components explain 67.8% of the variance
We found 5 as optimal number of clusters based on the gap statistic and the criteria from @tibshirani2001estimating.

```{r, include=FALSE}

plot <- readRDS(paste0(gettorepo, "results/clustering/gap_pc3_centered_kmeans_plot.rds"))
get_tibsh_k_from_gapplot <- function(df) {
  gk <- df[,"gap"]
  l <- length(gk)
  gk <- gk[-l]
  gk1 <- df[,"gap"][-1]
  sk1 <- df[,"SE.sim"][-1]
  d <- gk1 - sk1
  return(which(gk >= d)[1])
}
get_tibsh_k_from_gapplot(plot$data)
```

We show the map plot for the $k$-means clustering after applying the PCA as well as the time series of the resulting clusters.

```{r, echo = FALSE}
km_pca_map_plot <- readRDS(paste0(gettorepo,("results/clustering/km_pca_map_plot.rds")))
c1_pca_km <- readRDS(paste0(gettorepo,"results/clustering/c1_pca_km_plot.rds"))
c2_pca_km <- readRDS(paste0(gettorepo,"results/clustering/c2_pca_km_plot.rds"))
c3_pca_km <- readRDS(paste0(gettorepo,"results/clustering/c3_pca_km_plot.rds"))
c4_pca_km <- readRDS(paste0(gettorepo,"results/clustering/c4_pca_km_plot.rds"))
c5_pca_km <- readRDS(paste0(gettorepo,"results/clustering/c5_pca_km_plot.rds"))
```

```{r cluster-map, echo = FALSE, out.width= '50%',fig.cap= "Spatial distribution of the found clusters in the CAB. We applied a centered PCA on the data and used 3 principal components before applying the k-means algorithm"}
km_pca_map_plot + 
ggtitle("Precipitation clusters in the CAB,
after centered PCA, using 3 PC's and applying k-means")
```

Figure \@ref(fig:cluster-map) shows the grid cells in the Central Amazon Basin colored according to the clusters that are assigned by $k$-means. The clusters are almost
completely spatially coherent. Meaning that the clusters are not scattered
across different areas. One exception can be seen for Cluster 1 and 4. Parts of cluster 1 (orange) are inside cluster 4 (blue) and on the edge to cluster 3 (green).


```{r ts-clust, echo = FALSE, fig.cap= "Plots of the time series in the clusters we found using the k-means algorithm. The x-axis shows the month of measurement, the y-axis the centered precipitation. Centering was done according to the overall CAB mean in each month. The mean inside each cluster for a month is displayed in blue.", fig.align='center'}
l <- list(c1_pca_km, c2_pca_km, c3_pca_km,
          c4_pca_km, c5_pca_km)
quick <- function(a) {
  a$labels$title <- paste("Cluster", a$labels$subtitle)
  a$labels$subtitle <- NULL
  return(a)
} 
l <- lapply(l, function(x) quick(x))
# c1_pca_km + c2_pca_km + c3_pca_km + c4_pca_km +
#   c5_pca_km
l[[1]] + l[[2]] + l[[3]] + l[[4]] + l[[5]]
```

We now inspect the original (centered) time series inside the clusters (\@ref(fig:ts-clust)).  
The time series are shown in gray and the monthly mean in the cluster is shown in blue. Since the time series are centered before applying the PCA and clustering, the zero value is the mean of the respective month of the whole CAB.  
The clusters differ in their monthly differences from the monthly CAB mean (here 0 because the time series were centered before PCA and $k$-means) and their fluctuation/ variance. Also the size of the clusters are not all the same.  
The mean in cluster 3 has lowest variability around the CAB mean, followed by clusters 2 and 5, and clusters 1 and 4 have the highest variability.  
On average cluster 3 is on the level of the CAB overall mean.
The clusters 2 and 5 are slightly below and cluster 4 is above the CAB mean,
on average. Cluster 1 is on average also on the CAB mean but shows more variance than cluster 3.


