# EDA precipitation

In this section we want study the time series of precipitation in the
Central Amazon Basin.

We use the location that is also used in @ciemer2020early.

```{r}
knitr::opts_chunk$set(echo=FALSE)
```


```{r}
library(ggplot2)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(raster)
library(patchwork)
```

```{r}
source("../code/R/helper-functions.R")
```

```{r, include=FALSE}
world <- ne_countries(scale = "medium", returnclass = "sf")
class(world)
theme_set(theme_bw())
```

```{r, include=FALSE}
ggplot(data = world) +
  geom_sf() +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("World map", subtitle = paste0("(", length(unique(world$name)), " countries)"))
```

Time frame: 1980 to 2016

## Overview
```{r, include=FALSE}
# helpers
plot_summary <- function(summary) {
  df <- base::as.data.frame(cbind(coordinates(summary), summary@data@values))
  colnames(df) <- c("Longitude","Latitude", "val")
  plt <- ggplot(data = df, aes(x = Longitude, y = Latitude, fill = val)) +
    geom_raster(interpolate = FALSE) +
    scale_fill_gradient2(low = "red", high = "blue", midpoint = mean(df$val))
  return(plt)
}

plot_trends <- function(data, trends) {
  df <- base::as.data.frame(cbind(coordinates(data), trends))
  colnames(df) <- c("Longitude","Latitude", "val")
  plt <- ggplot(data = df, aes(x = Longitude, y = Latitude, fill = val)) +
    geom_raster(interpolate = FALSE) +
    scale_fill_gradient2(low = "red", high = "blue", midpoint = mean(df$val))
  return(plt)
}
```


Below the are of the Central Amazon Basin that is object of our study.

```{r, echo=FALSE}
ggplot(data = world) +
  geom_sf() +
  coord_sf(xlim = c(-100,-20), ylim = c(40,-40), expand = TRUE) +   geom_rect(xmin = -70, xmax = -55, ymin = -10, ymax = 0,
                                                                              fill = NA, colour = "black", size = 1.5)
```

```{r}
precip <- brick("../data/interim/drought/chirps_setreftime.nc")
precip <- raster::aggregate(precip, fact = 10)
```

## Mean at each location
```{r}
r_mean <- calc(precip, mean)
#plot(r_mean)
plot_summary(r_mean) + ggtitle("Mean of precipitation for each location")
```

```{r}
df_mean <- data.frame(means = values(r_mean))
ggplot(df_mean, aes(x = means)) + geom_density() + ggtitle("Density of means computed on each location")
```

As we can see most locations have a mean precipitation of around 200 mm/month, over
the whole time series. Regionally in the "upper left" corner of the Amazon Basin,
mean precipitation is higher or equal to the mean. The reference
point for "higher" is the mean of the location means. This region seems to be more
or less spatially consistent. The rest of the region with lower mean precipitation
has also some small areas where precipitation is again a little bit higher. 
For example in the upper right corner and on the bottom, right of the middle.


## SD at each location
```{r}
r_sd <- calc(precip, sd)
#plot(r_sd)
plot_summary(r_sd) + ggtitle("SD of precipitation for each location")
```

```{r}
df_sd <- data.frame(sd = values(r_sd))
ggplot(df_sd, aes(x = sd)) + geom_density()
```

For the standard deviation we also see regional patterns. These patterns overlap
with the regions of the mean but their magnitude is flipped. Meaning,
in the upper left where we observe larger mean values we generally observe lower
standard deviation and in the lower and upper right corners, higher standard 
deviations.

Question: There are obviously regional differences in magnitude of mean
and standard deviations. Should we therefore NOT normalise the time series, prior
to clustering? Mean and SD contain information and the variables are all measured 
on the same scale. (Consideration: seasonality might play a role, meaning
that the values of different months come a different distribution)

## Trend at each location
```{r, include=FALSE}
get_trend <- function(vec) {
  b <- seq(length(vec))
  trend <- lm(vec ~ b)$coefficients[2]
  return(trend)
}
```


```{r}
trends <- apply(getValues(precip), 1, get_trend)
plot_trends(precip, trends)
df_trends <- data.frame(tr = trends)
ggplot(df_trends, aes(x = tr)) + geom_density()
```

Many regions dont have a trend and trends in general seem to be quite small.
We can identify some regions with similar up or downward trends.
We also computed plots for the deseasonalised data but it looked almost the same

Plot means and sd for each month respectively
```{r,include=FALSE}
create_ind_mat <- function(precip_data) {
  ind_mat <- matrix(NA, nrow = 12, ncol = nlayers(precip_data)/12)
  for(i in 1:12) {
    ind_mat[i,] <- seq(i, ncol(ind_mat), 12)
  }
  return(ind_mat)
}

mon_plots <- function(precip_data) {
  ind_mat <- create_ind_mat(precip_data)
  plot_list_m <- list()
  plot_list_sd <- list()
  pvals <- getValues(precip_data)
  for(i in 1:nrow(ind_mat)) {
    mon <- subset(precip_data, ind_mat[i,])
    mon_means <- calc(mon, mean)
    mon_sd <- calc(mon, sd)
    m_plot <- plot_summary(mon_means) + ggtitle(paste("Means for month", i))
    sd_plot <- plot_summary(mon_sd)  + ggtitle(paste("SD for month", i))
    plot_list_m[[i]] <- m_plot
    plot_list_sd[[i]] <- sd_plot
  }
  return(list(plot_list_m,plot_list_sd))
}
```


```{r}
plt_list <- mon_plots(precip)
mon_mean <- plt_list[[1]]
mon_sd <- plt_list[[2]]
```


## Means per month



### January

```{r}
mon_mean[[1]]
```

### February

```{r}
mon_mean[[2]]
```

### March

```{r}
mon_mean[[3]]
```

### April

```{r}
mon_mean[[4]]
```

### May

```{r}
mon_mean[5]
```

### June

```{r}
mon_mean[[6]]
```


### July

```{r}
mon_mean[[7]]
```

### August

```{r}
mon_mean[[8]]
```

### September

```{r}
mon_mean[[9]]
```

### October

```{r}
mon_mean[[10]]
```

### November

```{r}
mon_mean[[11]]
```

### December

```{r}
mon_mean[[12]]
```

### {-}

We see spatial patterns of the mean evolving over time.
For example: From May until August there is a spatial separation in 
two parts that dissolves in september.
As expected there is a large seasonal component regarding the means.


## SD per month

### January

```{r}
mon_sd[[1]]
```

### February

```{r}
mon_sd[[2]]
```

### March

```{r}
mon_sd[[3]]
```

### April

```{r}
mon_sd[[4]]
```

### May

```{r}
mon_sd[[5]]
```

### June

```{r}
mon_sd[[6]]
```


### July

```{r}
mon_sd[[7]]
```

### August

```{r}
mon_sd[[8]]
```

### September

```{r}
mon_sd[[9]]
```

### October

```{r}
mon_sd[[10]]
```

### November

```{r}
mon_sd[[11]]
```

### December

```{r}
mon_sd[[12]]
```

### {-}

For the standard deviation we see as well large differences in values 
during different months of the year.

```{r, include = FALSE}
#Do we get stationary time series when we only take each january or february?
#Check for stationarity of the different time series?
#### Open: summarise CAB for each month (mean Jan, Feb, etc.)

```
