---
title: "eda-precip"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages}
library(ncdf4)
library(raster)
library(rgdal)
library(ggplot2)
library(assertthat)
```
```{r set filepath and variable name}
file_name <- "precip-interim.nc"
path <- paste0("../../data/interim/", file_name)
var <- "precip"
fill_name <- "missing_value"
to_flip <- FALSE
getwd()
```


```{r load data, variables and preprocess}
# Note working directory is location of file
file <- nc_open(path)
data <- ncvar_get(file, var)
lon <- ncvar_get(file, "lon")
lat <- ncvar_get(file, "lat")
fill_val <- ncatt_get(file, var, fill_name)
nc_close(file)
data[data == fill_val$value] <- NA
```
The data contains `r dim(data)[3]` months of Sea Surface Temperature 
data, in the geographical window from `r `min(lon)` to `r max(lon)`
longitude and `r min(lat)` to `r max(lat)` latitude respectively.
On a resolution of a `ncatt_get(file,0)$spatial_resolution`
The temperature is measured in degrees celsius.
Let's see how this looks like.
We randomly choose one month to plot

```{r}
set.seed(420)
m <- sample(seq(dim(data)[3]), 1)
slice <- data[,,m]
r <- raster(t(slice), xmn = min(lon), xmx = max(lon), ymn = min(lat), ymx = max(lat), 
            crs = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0"))
if (to_flip) r <- flip(r, direction = "y")
plot(r)
```
Next we inspect the development of the monthly mean temperatures over tim

```{r}
monthly_mean <- apply(data, 3, function(x) mean(x, na.rm = TRUE))
df <- data.frame(t = seq(dim(data)[3]),temp =  monthly_mean)
lw <- loess(temp ~ t, data = df)
ggplot(data = df, aes(x = t, y = temp)) + geom_line() + geom_smooth(method = "auto")
```
The only NA's are the the grid points that refer to continental grid points.

```{r}
# NA is alwyas th same, since only land is NA
gap <- which(is.na(slice), arr.ind = TRUE)
find <- apply(data, 3, function(x) all(which(is.na(x), arr.ind = TRUE) == gap))
length(find) == sum(find)
```