---
title: "EDA Hadcrut"
output:
  pdf_document: default
  html_notebook: default
---
In this notebook we want to explore the sst data from
https://www.ncdc.noaa.gov/data-access/marineocean-data/extended-reconstructed-sea-surface-temperature-ersst-v5.
Preprocessing involved: 
- merging monthly files, into on large file.
- restricting the geographical window (longitude and latitude)

```{r load packages, message = FALSE}
library(ncdf4)
library(raster)
library(rgdal)
library(ggplot2)
library(assertthat)
```

```{r load data, variables and preprocess}
# Note working directory is location of file
file <- nc_open("../../data/raw/hadcrut/HadCRUT.5.0.1.0.analysis.anomalies.ensemble_mean.nc")
varname <- "tas_mean"
data <- ncvar_get(file, varname)
lon <- ncvar_get(file, "longitude_bnds")
lat <- ncvar_get(file, "latitude_bnds")
fill_val <- ncatt_get(file, varname, "_FillValue")
nc_close(file)
data[data == fill_val$value] <- NA
```
The data contains `r dim(data)[3]` months of Temperature 
data, in the geographical window from `r min(lon)` to `r max(lon)`
longitude and `r min(lat)` to `r max(lat)` latitude respectively.
On a resolution of a `ncatt_get(file,0)$spatial_resolution`
The temperature is measured in celsius.
Let's see how this looks like.
We randomly choose one month to plot

```{r}
set.seed(420)
m <- sample(seq(dim(data)[3]), 1)
slice <- data[,,m]
r <- raster(t(slice), xmn = min(lon), xmx = max(lon), ymn = min(lat), ymx = max(lat), 
            crs = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0"))
r <- flip(r, direction = "y")
plot(r)
```
Next we inspect the development of the monthly mean temperatures over tim

```{r}
monthly_mean <- apply(data, 3, function(x) mean(x, na.rm = TRUE))
df <- data.frame(t = seq(dim(data)[3]),temp =  monthly_mean)
lw <- loess(temp ~ t, data = df)
ggplot(data = df, aes(x = t, y = temp)) + geom_line() + geom_smooth(method = "auto")
```
The only NA's are the the grid points that refer to continental grid points.

```{r}
# NA is alwyas th sane, since only land is NA
gap <- which(is.na(slice), arr.ind = TRUE)
find <- apply(data, 3, function(x) all(which(is.na(x), arr.ind = TRUE) == gap))
length(find) == sum(find)
```


