---
title: "Detrend and Deseaonalise Time Series"
author: "Dario Lepke"
date: "7 7 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("./../../"))
```
```{r}
set.seed(1234)
library(raster)
library(ggplot2)
library(dplyr)
getwd()
```
Load preprocessed data

```{r}
sst <- brick("data/interim/sst/ersst_setreftime.nc",
             varname= "ssta")
#mean_test <- calc(test, fun=mean,na.rm=TRUE)
#plot(mean_test)

sst
```

Plot some of the time series

extract one time series of values for random grid point that is not NA

```{r}
# in: brick object
# out: random gridcell that is not on land
#      x is longitude, y is latitude

get_random_cell <- function(brick) {
  # get one layer as a raster object
  r <- raster(brick, layer = 1)
  l <- length(r)
  vals <- getValues(r)
  not_na <- which(!is.na(vals))
  rnd_cell <- sample(not_na, 1)
  lonlat <- xyFromCell(r, rnd_cell)
  return(lonlat)
}

sst_cell <- get_random_cell(sst)


```


```{r}
# in: lonlat info of sea grid point
# out: a ggplot of point on map
plot_cell <- function(cell) {
  # Using GGPLOT, plot the Base World Map
  mp <- NULL
  mapWorld <- borders("world", colour="gray50", fill="gray50") # create a layer of borders
  mp <- ggplot() +   mapWorld
  
  #vNow Layer the cities on top
  mp <- mp+ geom_point(aes(x=cell[1], y=cell[2]), ,color="blue", size=3)
  mp
}

plot_cell(sst_cell)

```

```{r}
# in: dataset and respective cellpoint
# out: ggplot of time series data for cellpoint
get_ts <- function(data,cell) {
  vals <- c(extract(data,cell))
}

sst_ts <- get_ts(sst, sst_cell)

plot_ts <- function(ts) {
  df <- as.data.frame(ts)
  df$month <- 1:length(ts)
  ggplot(df, aes(x=month, y=ts)) + geom_point() +
    geom_line() + geom_smooth()
  
}

plot_ts(sst_ts)
```
Deasonalise and detrend one time series SST

We decompose this time series using the stl function,
which in turn uses loess to decompose a time series.
We create a time series object with frequency 12, since
we use monthly observations, looking for a yearly effect?

$$Monthly Temperatures = Seasonal + Trend + Remainder$$
Deasonalise and detrend all time series SST
OPEN

```{r}
plot_stl <- function(values) {
  time_series <- ts(values, frequency = 12)
  time_series %>% stl(t.window = 12, s.window = "periodic", robust = TRUE) %>% forecast::autoplot()
}

plot_stl(sst_ts)
```

We have a strong seasonal component here, as can be seen by the bar on the right hand side of the plots.


For Precip
```{r}
precip <- brick("data/interim/drought/chirps_setreftime.nc", varname = "precip")
#mean_test2 <- calc(test2, fun=mean, na.rm=TRUE)
#plot(mean_test2)
precip
```

choose random cell
```{r}
cell_precip <- get_random_cell(precip)
```

Plot some of the time series
```{r}
plot_cell(cell_precip)
```

```{r}
precip_ts <- get_ts(precip, cell_precip)
plot_ts(precip_ts)
```
```{r}
plot_stl(precip_ts)
```
Her for the precip data we have a stronger trend, than a seasonal effect?


Compute mean of each month for the Precip time series,
get one amazonas rainfall/precip value for each month
Deasonalise and detrend the monthly means

