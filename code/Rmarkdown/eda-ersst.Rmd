---
title: "EDA ERSST Data"
author: "Dario Lepke"
date: "10 6 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages, message = FALSE, warning = FALSE, echo=FALSE}
library(ncdf4)
library(raster)
library(rgdal)
library(ggplot2)
library(assertthat)
library(lubridate)
library(printr)
```

## Introduction{-}

We explore the **sea surface temperature data** set, used in the paper by Ciemer et al. 
ERSST (Extended Reconstructed Sea Surface Temperature) is a reanalysis from observed data given in the Internation Comprehensive Ocean-Athmosphere Data Set (ICOADS). Which contains observation **from 1800/01 until 2016/12**, made by ships and buoys for example.
The data comes on a **2x2 degree grid**, where data was missing **interpolation techniques were used**.
See paper for reference.

## Download and file merging{-}
Data comes in seperate files for each month but can be downloaded to the working directory via bash.

```{bash, eval = FALSE}
yr=1880
while [ $yr -le 2016 ]; do
nm=1
while [ $nm -le 12 ]; do
if [ $nm -lt 10 ]; then
nm=0$nm
fi
wget ftp://ftp.ncdc.noaa.gov/pub/data/cmb/ersst/v5/netcdf/ersst.v5.$yr$nm.nc
nm=`expr $nm + 1`
done
yr=`expr $yr + 1`
done
```

We then use the Climate Data Operators (CDO) Software to handle the files for preprocessing.
We do so by using the CDO software on an Ubuntu distribution installed on Windows via WSL2.
To access the files on Windows in the C folder via Ubuntu we use. 

```{bash, eval = FALSE}
cd /mnt/c
```

Then the working directory has to be set to the location of the repository "MA-climate".
After that we can use the following command to merge the single files into one.

```{bash, eval = FALSE}
cdo mergetime data/raw/sst/ersst/*.nc data/raw/sst/ersst.nc
```

Note u may have to check and change the maximum number of open files.

```{bash, eval = FALSE}
ulimit -n 2000
```


## Quick overview {-}

We load and inspect the data.

### Single file {-}

We inspect the metadata of one single file, this is a large output, shown here only for a matter of completeness, we
summarise the important information below.

```{r}
ersst<- nc_open("../../data/raw/sst/ersst/ersst.v5.201612.nc")
```

```{r}
print(ersst)
```

We see the file contains **two variables** that are measured across different dimensions.
The two variables contain the **sea surface temperatures and the respective SST anomalies** (with respect to the 1971-2000 monthly climatology). Both are measured in celsius and we are **primarly interested in the anomalies** here.
The dimensions describe a longitude and latitude grid, one for each month. Here time dimension is one because we only opened a single file.


### Merged file {-}

We now shortly inspect the merged data.
```{r}
ersst <- nc_open("../../data/raw/sst/ersst.nc")
ersst_time <- ncvar_get(ersst, "time")
null_ersst <- as.POSIXct("1880-01-01 00:00", tz = "UTC")
first_ersst <- null_ersst + minutes(ersst_time[1]) # "1880-01-01 UTC"
last_ersst <- null_ersst + minutes(ersst_time[length(ersst_time)]) # 2014-12-28 UTC"
```

Note: 
Merging the data changed the reference date for the timestamps to "minutes since 1880-01-01 00:00".
The date of "last_ersst" differs from the actual measurement, which is 2016/12, also we can check this via 
data dimensions. 

```{r}
ersst_data <- ncvar_get(ersst, "ssta")
dim(ersst_data)[3]/12 #137 years of data
1880 + 137
```
Since the observations start in 1880 and we have 137 years of data, last observations are in the the end of 2016. 
(Open: Check why timestamps did not work in R.)

```{r}
ersst_lon <- ncvar_get(ersst, "lon")
ersst_lat <- ncvar_get(ersst, "lat")
```

### Summary merged file {-}
The data contains `r dim(ersst_data)[3]` months of Sea Surface Temperature 
data, in the geographical window from `r min(ersst_lon)` to `r max(ersst_lon)`
longitude and `r min(ersst_lat)` to `r max(ersst_lat)` latitude respectively.
On a resolution of a `r ncatt_get(ersst,0)$spatial_resolution`.
The temperature is measured in celsius.
The reference date for the timestamps is the 1854-01-15 measured in days.

## Preprocessing data structure 

We now preprocess the data so we can use it together with the CHIRPS data.
Via selyear we select the time frame that is covered by both datasets, namely 1981 until 2016.
With sellonlatbox we change the orientation of the grid cells so that they are the same in both datasets.
By using setreftime we set the origin date for the timestamps and the respective time unit, also to be the same in both data sets.

```{bash, eval = FALSE}
cdo -z zip selyear,1981/2016 data/raw/sst/ersst.nc data/interim/sst/ersst_selyear.nc

cdo -z zip sellonlatbox,-180,180,-90,90 data/interim/sst/ersst_selyear.nc data/interim/sst/ersst_sellonlatbox.nc

cdo -z zip setreftime,1900-1-1,00:00:00,months data/interim/sst/ersst_sellonlatbox.nc data/interim/sst/ersst_setreftime.nc

```

## First Plot

And plot one month of data.

```{r}
ersst <- nc_open("../../data/interim/sst/ersst_setreftime.nc")
ersst_data <- ncvar_get(ersst, "ssta")
ersst_lon <- ncvar_get(ersst, "lon")
ersst_lat <- ncvar_get(ersst, "lat")
ersst_time <- ncvar_get(ersst, "time")
fill_val <- ncatt_get(ersst, "ssta", "_FillValue")
ersst_data[ersst_data == fill_val$value] <- NA
nc_close(ersst)
```


```{r}
set.seed(42)
m <- sample(seq(dim(ersst_data)[3]), 1)
slice <- ersst_data[,,m]
r <- raster(t(slice), xmn = min(ersst_lon), xmx = max(ersst_lon), ymn = min(ersst_lat), ymx = max(ersst_lat), 
            crs = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0"))
r <- flip(r, direction = "y")
plot(r)
```
```{r}
dim(ersst_data) <- NULL
plot(density(na.omit(ersst_data)))
```


