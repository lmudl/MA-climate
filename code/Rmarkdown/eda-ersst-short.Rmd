---
title: "ERSST-short"
author: "Dario Lepke"
date: "25 6 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages, message = FALSE, warning = FALSE, echo=FALSE}
library(ncdf4)
library(raster)
library(rgdal)
library(ggplot2)
library(assertthat)
library(lubridate)
library(printr)
library(reshape2)
library(viridis)
library(sf)
library(rnaturalearth)

```

## Introduction{-}

We explore the **sea surface temperature data** set, used in the paper by Ciemer et al. 
ERSST (Extended Reconstructed Sea Surface Temperature) is a reanalysis from observed data given in the International Comprehensive Ocean-Athmosphere Data Set (ICOADS). Which contains observations **from 1800/01 until 2016/12**, made by ships and buoys for example.
The data comes on a **2x2 degree grid**, where data was missing **interpolation techniques were used**.
See paper for reference.

## Download and file merging{-}
Data comes in seperate files for each month but can be downloaded to the working directory via bash.

```{bash, eval = FALSE}
yr=1880
while [ $yr -le 2016 ]; do
nm=1
while [ $nm -le 12 ]; do
if [ $nm -lt 10 ]; then
nm=0$nm
fi
wget ftp://ftp.ncdc.noaa.gov/pub/data/cmb/ersst/v5/netcdf/ersst.v5.$yr$nm.nc
nm=`expr $nm + 1`
done
yr=`expr $yr + 1`
done
```

We then use the Climate Data Operators (CDO) Software to handle the files for preprocessing.
We do so by using the CDO software on an Ubuntu distribution installed on Windows via WSL2.
To access the files on Windows in the C folder via Ubuntu we use. 

```{bash, eval = FALSE}
cd /mnt/c
```

Then the working directory has to be set to the location of the repository "MA-climate".
After that we can use the following command to merge the single files into one.

```{bash, eval = FALSE}
cdo mergetime data/raw/sst/ersst/*.nc data/raw/sst/ersst.nc
```

Note you may have to check and change the maximum number of open files.

```{bash, eval = FALSE}
ulimit -n 2000
```


## Quick overview {-}

We load and inspect the data.

### Variables

```{r}
ersst <- nc_open("../../data/raw/sst/ersst.nc")
names(ersst$var)
```
We see the file contains **two variables** that are measured across different dimensions.
The two variables contain the **sea surface temperatures and the respective SST anomalies** (with respect to the 1971-2000 monthly climatology). Both are measured in celsius and we are **primarly interested in the anomalies** here.

### Dimensions

```{r}
ersst_data <- ncvar_get(ersst, "ssta")
dim(ersst_data)
```
The data is given on longitude and latitude grid, denoting the first two dimensions. The third dimension gives the number of months that were observed. Note also that there is a fourth dimension in the dataset which gives the depth in which the measurements were taken ("lev"), but this is all 0.

```{r}
names(ersst$dim)
ersst$dim$lev$vals
```

#### Latitude and Longitude

```{r}
# get lon and lat
ersst_lon <- ncvar_get(ersst, "lon")
range(ersst_lon)
ersst_lat<- ncvar_get(ersst, "lat")
range(ersst_lat)

```

The longitude ranges from 0 to 358 and the latitude from -88 to 88 degrees.

#### Time

```{r}
ersst_time <- ncvar_get(ersst,"time")
ersst_time_units <- ncatt_get(ersst, "time", attname = "units")
ersst_time_units$value

```
Time is measured in minutes since 1880-01-01

### Summary merged file {-}
The data contains **`r dim(ersst_data)[3]` months** of Sea Surface Temperature 
data, in the geographical window from **`r min(ersst_lon)` to `r max(ersst_lon)`**
longitude and **`r min(ersst_lat)` to `r max(ersst_lat)`** latitude respectively.
On a **resolution of `r ncatt_get(ersst,0)$spatial_resolution`**.
The temperature is measured in celsius.
The reference for the timestamps is **minutes since 1880-01-01.**

## Preprocessing data structure 

We now preprocess the data so we can use it together with the CHIRPS data.
Via **selyear** we select the time frame that is covered by both datasets, namely 1981 until 2016.
With **sellonlatbox** we change the orientation of the grid cells so that they are the same in both datasets.
By using **setreftime** we set the origin date for the timestamps and the respective time unit, also to be the same in both data sets.

```{bash, eval = FALSE}
cdo -z zip selyear,1981/2016 data/raw/sst/ersst.nc data/interim/sst/ersst_selyear.nc

cdo -z zip sellonlatbox,-180,180,-90,90 data/interim/sst/ersst_selyear.nc data/interim/sst/ersst_sellonlatbox.nc

cdo -z zip setreftime,1900-1-1,00:00:00,months data/interim/sst/ersst_sellonlatbox.nc data/interim/sst/ersst_setreftime.nc

```

## First Plot

And plot one month of data.

```{r}
ersst <- nc_open("../../data/interim/sst/ersst_setreftime.nc")
ersst_data <- ncvar_get(ersst, "ssta")
ersst_lon <- ncvar_get(ersst, "lon")
ersst_lat <- ncvar_get(ersst, "lat")
fill_val <- ncatt_get(ersst, "ssta", "_FillValue")
ersst_data[ersst_data == fill_val$value] <- NA
```

```{r}
# max(ersst_data,na.rm = TRUE)
# min(ersst_data,na.rm=TRUE)
# plot(density(ersst_data, na.rm=TRUE))
# table(ersst_data)

```


```{r}
ret <- list()
ret$lat <- ersst_lat
ret$lon <- ersst_lon
ret$time <- ncvar_get(ersst, "time")
ret$sst <- ersst_data
ret$date <- paste("26-06-2021")
str(ret)
```
```{r}
melt_sst <- function(L) {
  dimnames(L$sst) <- list(lon = L$lon, lat = L$lat)
  ret <- melt(L$sst, value.name = "sst")
  cbind(date=L$date, ret)
}
```

```{r}
sst <- melt_sst(ret)
sst
```

```{r}
ggplot(data = sst, aes(x = lon, y = lat, fill = sst)) + 
  annotation_map(map_data("world")) +
  geom_raster(interpolate = TRUE) +
  #geom_polygon(aes(fill=sst, colour = "black")) +
  scale_fill_viridis_c(option="A") +
  theme_bw() +
  coord_quickmap() 
```


```{r}
ggplot(data = sst, aes(x = lon, y = lat, fill = sst)) + 
  borders(fill = "grey", colour = "black") +   
  geom_raster(interpolate = FALSE) +
  scale_fill_gradientn(colours = rev(rainbow(7)), na.value = NA) +
  coord_quickmap()
```

```{r}
worldmap <- ne_countries(scale = 'medium', type = 'map_units',
                         returnclass = 'sf')
ggplot(data=worldmap) + geom_sf() + geom_point(data=sst, aes(x=lon, y=lat), fill=sst) +
  #geom_raster(aes(x=lon,y=lat),interpolate = TRUE) +
  scale_fill_gradientn(colours = rev(rainbow(7)), na.value = NA) +
  coord_sf()
```




```{r}
set.seed(42)
m <- sample(seq(dim(ersst_data)[3]), 1)
slice <- ersst_data[,,m]
r <- raster(t(slice), xmn = min(ersst_lon), xmx = max(ersst_lon), ymn = min(ersst_lat), ymx = max(ersst_lat), 
            crs = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0"))
r <- flip(r, direction = "y")
plot(r)
```




## Appendix {-}

Contains all the meta information on the merged file.
Also a change log

```{r}
print(ersst)
nc_close(ersst)

```

